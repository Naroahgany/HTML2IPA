name: Auto Build IPA (Unique ID)

on:
  workflow_dispatch:  # 手动触发

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Smart Build IPA with Unique ID
        run: |
          # --- 1. 智能查找项目名称 ---
          PROJECT_FILE=$(find . -maxdepth 2 -name "*.xcodeproj" | head -n 1)
          if [ -z "$PROJECT_FILE" ]; then
            echo "错误：找不到 .xcodeproj 项目文件！"
            exit 1
          fi
          PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
          SCHEME_NAME="$PROJECT_NAME"
          echo "✅ 检测到项目名称: $PROJECT_NAME"

          # --- 2. 生成随机身份证号 (Bundle ID) ---
          # 生成一个随机数，确保每次打包都是唯一的，彻底解决冲突问题
          RANDOM_ID="com.custom.aiweb.$(date +%s)"
          echo "✅以此 ID 构建: $RANDOM_ID"

          # --- 3. 清理与构建 (强制覆盖 Bundle ID) ---
          xcodebuild clean -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME_NAME" -configuration Release

          # 关键修改：添加 PRODUCT_BUNDLE_IDENTIFIER 参数
          xcodebuild build \
            -project "$PROJECT_NAME.xcodeproj" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -derivedDataPath build \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="$RANDOM_ID"

          # --- 4. 打包 IPA ---
          mkdir Payload
          APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "❌ 构建失败，未找到 .app 文件"
            exit 1
          fi

          echo "✅ 正在打包: $APP_PATH"
          cp -r "$APP_PATH" Payload/
          zip -r "AI_Chat_App.ipa" Payload

      - name: Upload IPA to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: AI_Chat_App_IPA
          path: ./*.ipa
