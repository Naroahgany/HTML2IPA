name: Kingfall V6 (Strict Icon Fix)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: âš¡ï¸ Diagnose & Reconstruct Icons
        run: |
          # --- 1. å¯»æ‰¾ç”¨æˆ·ä¸Šä¼ çš„å›¾æ ‡ (ä¸åˆ†å¤§å°å†™) ---
          # å¯»æ‰¾æ ¹ç›®å½•ä¸‹ä»»ä½•å« icon.png/jpg/jpeg çš„æ–‡ä»¶
          SOURCE_ICON=$(find . -maxdepth 1 -iname "icon.png" -o -iname "icon.jpg" -o -iname "icon.jpeg" | head -n 1)

          if [ -z "$SOURCE_ICON" ]; then
            echo "ğŸ›‘ è‡´å‘½é”™è¯¯ï¼šæœªæ‰¾åˆ° icon.pngï¼"
            echo "è¯·ç¡®ä¿ä½ ä¸Šä¼ äº†å›¾ç‰‡ï¼Œå¹¶ä¸”åå­—æ˜¯ icon.png (æˆ–è€… icon.jpg)"
            echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼š"
            ls -la
            exit 1
          fi

          echo "âœ… æ‰¾åˆ°æºå›¾ç‰‡: $SOURCE_ICON"

          # --- 2. å®šä½å›¾æ ‡æ–‡ä»¶å¤¹ ---
          ICON_SET_PATH=$(find . -type d -name "AppIcon.appiconset" | head -n 1)
          if [ -z "$ICON_SET_PATH" ]; then
             echo "ğŸ›‘ è‡´å‘½é”™è¯¯ï¼šæ‰¾ä¸åˆ° AppIcon.appiconset æ–‡ä»¶å¤¹ï¼"
             exit 1
          fi

          echo "âœ… å®šä½åˆ°èµ„æºç›®å½•: $ICON_SET_PATH"
          
          # --- 3. æš´åŠ›é‡å»º (Nuclear Rebuild) ---
          # å“ªæ€•åŸæ–‡ä»¶å¤¹æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬ä¹Ÿå¼ºåˆ¶ç”Ÿæˆæ ‡å‡†å°ºå¯¸
          # iOS éœ€è¦çš„å¸¸è§å°ºå¯¸ï¼š20, 29, 40, 58, 60, 76, 80, 87, 120, 152, 167, 180, 1024
          
          # å®šä¹‰ä¸€ä¸ªç”Ÿæˆå‡½æ•°
          generate_icon() {
            SIZE=$1
            FILENAME="$ICON_SET_PATH/Icon-$SIZE.png"
            sips -Z $SIZE "$SOURCE_ICON" --out "$FILENAME" > /dev/null
          }

          echo "âš¡ï¸ æ­£åœ¨ç”Ÿæˆå…¨å¥—å›¾æ ‡..."
          generate_icon 1024
          generate_icon 180
          generate_icon 167
          generate_icon 152
          generate_icon 120
          generate_icon 87
          generate_icon 80
          generate_icon 76
          generate_icon 60
          generate_icon 58
          generate_icon 40
          generate_icon 29
          generate_icon 20

          # å¼ºåˆ¶è¦†ç›–åŸæœ‰çš„ Contents.json é‡Œçš„å›¾ç‰‡å¼•ç”¨ (ç®€å•ç²—æš´æ³•ï¼šè¦†ç›–æ‰€æœ‰åŒåæ–‡ä»¶)
          # è¿™ä¸€æ­¥æ˜¯ä¸ºäº†é˜²æ­¢åŸæœ‰çš„ Contents.json æŒ‡å‘äº†ä¸å­˜åœ¨çš„æ–‡ä»¶å
          # æˆ‘ä»¬æŠŠåˆšæ‰ç”Ÿæˆçš„å›¾ç‰‡ï¼Œå¤åˆ¶ä¸€ä»½ç»™æ‰€æœ‰åŸæœ¬å­˜åœ¨çš„ PNG æ–‡ä»¶å
          find "$ICON_SET_PATH" -name "*.png" | while read EXISTING_IMG; do
             # è·å–åŸå›¾éœ€è¦çš„å°ºå¯¸
             TARGET_WIDTH=$(sips -g pixelWidth "$EXISTING_IMG" | awk '/pixelWidth:/{print $2}')
             if [ -n "$TARGET_WIDTH" ]; then
                sips -Z $TARGET_WIDTH "$SOURCE_ICON" --out "$EXISTING_IMG" > /dev/null
             fi
          done

          echo "ğŸ‰ å›¾æ ‡é‡å»ºå®Œæˆï¼"

      - name: Build IPA (FangYiKai)
        run: |
          PROJECT_FILE=$(find . -maxdepth 2 -name "*.xcodeproj" | head -n 1)
          PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
          SCHEME_NAME="$PROJECT_NAME"
          
          # ç”Ÿæˆéšæœº ID é¿å… SideStore æŠ¥é”™
          RANDOM_ID="com.fangyikai.app.$(date +%s)"
          
          xcodebuild clean -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME_NAME" -configuration Release

          xcodebuild build \
            -project "$PROJECT_NAME.xcodeproj" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -derivedDataPath build \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="$RANDOM_ID"

          mkdir Payload
          RAW_APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          
          if [ -z "$RAW_APP_PATH" ]; then
             echo "âŒ æ„å»ºå¤±è´¥"
             exit 1
          fi

          # å¤åˆ¶å¹¶ä¿ç•™è‹±æ–‡å†…éƒ¨å
          cp -R "$RAW_APP_PATH" Payload/
          
          # æ‰“åŒ…
          zip -ry "FangYiKai_Fixed.ipa" Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: FangYiKai_Fixed_IPA
          path: ./*.ipa
