name: Kingfall Ultimate (HD Icons + Audio)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: âš¡ï¸ Check Source Icon
        run: |
          # å¯»æ‰¾ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡
          SOURCE_ICON=$(find . -maxdepth 1 -iname "icon.png" -o -iname "icon.jpg" -o -iname "icon.jpeg" | head -n 1)
          if [ -z "$SOURCE_ICON" ]; then
            echo "ğŸ›‘ é”™è¯¯ï¼šæ²¡æ‰¾åˆ° icon.pngï¼è¯·ç¡®è®¤æ–‡ä»¶å·²ä¸Šä¼ ï¼"
            exit 1
          fi
          echo "âœ… é”å®šæºå›¾æ ‡: $SOURCE_ICON (å°†ä½¿ç”¨åŸå›¾ç›´å‡ºæ¨¡å¼)"
          echo "SOURCE_ICON_PATH=$SOURCE_ICON" >> $GITHUB_ENV

      - name: Build Xcode Project
        run: |
          PROJECT_FILE=$(find . -maxdepth 2 -name "*.xcodeproj" | head -n 1)
          PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
          SCHEME_NAME="$PROJECT_NAME"
          
          # ç”Ÿæˆéšæœº IDï¼Œé˜²æ­¢ SideStore ç¼“å­˜å†²çª
          RANDOM_ID="com.fangyikai.app.$(date +%s)"
          
          xcodebuild clean -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME_NAME" -configuration Release
          
          xcodebuild build \
            -project "$PROJECT_NAME.xcodeproj" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -derivedDataPath build \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="$RANDOM_ID"

      - name: ğŸ’‰ Inject Raw HD Icons
        run: |
          # 1. å‡†å¤‡è·¯å¾„
          RAW_APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          mkdir Payload
          cp -R "$RAW_APP_PATH" Payload/FangYiKai.app
          
          TARGET_DIR="Payload/FangYiKai.app"
          SRC="${{ env.SOURCE_ICON_PATH }}"
          
          echo "ğŸ’ æ­£åœ¨æ‰§è¡Œã€åŸå›¾ç›´å‡ºã€‘æ¤å…¥..."
          echo "è­¦å‘Šï¼šä¸è¿›è¡Œä»»ä½•è£å‰ªæˆ–å‹ç¼©ï¼Œç¡®ä¿æœ€é«˜æ¸…æ™°åº¦ã€‚"
          
          # 2. ã€æ ¸å¿ƒæ“ä½œã€‘ç›´æ¥å¤åˆ¶åŸå›¾åˆ°æ‰€æœ‰å¯èƒ½çš„ç³»ç»Ÿæ–‡ä»¶å
          # æ— è®ºç³»ç»Ÿè¦60pxè¿˜æ˜¯180pxï¼Œæˆ‘ä»¬éƒ½ç»™å®ƒå–‚è¿™å¼ é«˜æ¸…å¤§å›¾
          
          # iPhone æ ¼å¼
          cp "$SRC" "$TARGET_DIR/AppIcon60x60@2x.png"
          cp "$SRC" "$TARGET_DIR/AppIcon60x60@3x.png"
          
          # iPad æ ¼å¼
          cp "$SRC" "$TARGET_DIR/AppIcon76x76@2x.png"
          cp "$SRC" "$TARGET_DIR/AppIcon83.5x83.5@2x.png"
          
          # é€šç”¨å…œåº•æ ¼å¼ (é˜²æ­¢ Info.plist é…ç½®é—æ¼)
          cp "$SRC" "$TARGET_DIR/AppIcon.png"
          cp "$SRC" "$TARGET_DIR/AppIcon@2x.png"
          cp "$SRC" "$TARGET_DIR/AppIcon@3x.png"
          cp "$SRC" "$TARGET_DIR/Icon.png"
          cp "$SRC" "$TARGET_DIR/Icon@2x.png"
          
          # 3. éªŒè¯æ–‡ä»¶å¤§å° (åŸå›¾é€šå¸¸è¾ƒå¤§ï¼Œå¦‚æœæ–‡ä»¶å¾ˆå¤§è¯´æ˜å¤åˆ¶æˆåŠŸ)
          echo "ğŸ“Š æ£€æŸ¥æ¤å…¥ç»“æœ (æ–‡ä»¶å¤§å°åº”ä¸åŸå›¾ä¸€è‡´):"
          ls -lh "$TARGET_DIR" | grep "png"

          # 4. æ‰“åŒ…
          zip -ry "FangYiKai_Ultimate.ipa" Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: FangYiKai_Ultimate_IPA
          path: ./*.ipa
