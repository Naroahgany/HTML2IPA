name: Custom App Build (Name & Icon)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Auto-Process Icon & Build
        run: |
          # --- 1. æ™ºèƒ½æŸ¥æ‰¾é¡¹ç›® ---
          PROJECT_FILE=$(find . -maxdepth 2 -name "*.xcodeproj" | head -n 1)
          if [ -z "$PROJECT_FILE" ]; then
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°é¡¹ç›®æ–‡ä»¶ï¼"
            exit 1
          fi
          PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
          SCHEME_NAME="$PROJECT_NAME"
          echo "âœ… é¡¹ç›®é”å®š: $PROJECT_NAME"

          # --- 2. å›¾æ ‡è‡ªåŠ¨åŒ–æ›¿æ¢ç³»ç»Ÿ (Kingfall Engine) ---
          # å¯»æ‰¾é¡¹ç›®ä¸­çš„ AppIcon æ–‡ä»¶å¤¹
          ICON_SET_PATH=$(find . -type d -name "AppIcon.appiconset" | head -n 1)
          SOURCE_ICON="icon.png"

          if [ -f "$SOURCE_ICON" ] && [ -n "$ICON_SET_PATH" ]; then
            echo "âœ… å‘ç°è‡ªå®šä¹‰å›¾æ ‡: $SOURCE_ICON"
            echo "âš¡ï¸ æ­£åœ¨å¯åŠ¨è‡ªåŠ¨åˆ‡å›¾å¼•æ“..."
            
            # éå†ç›®æ ‡æ–‡ä»¶å¤¹é‡Œçš„æ‰€æœ‰åŸæœ‰ PNG å›¾æ ‡
            find "$ICON_SET_PATH" -name "*.png" | while read TARGET_IMG; do
              # è·å–åŸå›¾æ ‡çš„å°ºå¯¸ (ä¾‹å¦‚ 120)
              WIDTH=$(sips -g pixelWidth "$TARGET_IMG" | awk '/pixelWidth:/{print $2}')
              
              # å°†ç”¨æˆ·çš„ icon.png ç¼©æ”¾è‡³è¯¥å°ºå¯¸ï¼Œå¹¶è¦†ç›–åŸå›¾
              sips -Z $WIDTH "$SOURCE_ICON" --out "$TARGET_IMG" > /dev/null
              # echo "  - å·²æ›¿æ¢: $WIDTH px -> $TARGET_IMG"
            done
            echo "ğŸ‰ å›¾æ ‡æ›¿æ¢å®Œæˆï¼"
          else
            echo "âš ï¸ æœªåœ¨æ ¹ç›®å½•å‘ç° icon.pngï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡ã€‚"
          fi

          # --- 3. ç”Ÿæˆéšæœº Bundle ID (é˜²æ­¢å®‰è£…å¤±è´¥) ---
          RANDOM_ID="com.custom.app.$(date +%s)"
          echo "âœ… ç”Ÿæˆå”¯ä¸€ ID: $RANDOM_ID"

          # --- 4. æ¸…ç†ä¸æ„å»º ---
          xcodebuild clean -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME_NAME" -configuration Release

          # å¼ºåˆ¶è¦†ç›– ID å¹¶æ„å»º
          xcodebuild build \
            -project "$PROJECT_NAME.xcodeproj" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -derivedDataPath build \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="$RANDOM_ID"

          # --- 5. æ‰“åŒ… IPA ---
          mkdir Payload
          APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ° .app æ–‡ä»¶"
            exit 1
          fi

          # è¿™é‡Œçš„åå­—åªä¼šå½±å“ä¸‹è½½çš„æ–‡ä»¶åï¼Œä¸ä¼šå½±å“å®‰è£…åçš„åå­—
          zip -r "My_Custom_App.ipa" Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: My_Custom_App_IPA
          path: ./*.ipa
