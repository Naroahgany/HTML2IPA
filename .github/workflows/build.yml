name: Kingfall HD Icon Build

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: âš¡ï¸ Check Source Icon
        run: |
          SOURCE_ICON=$(find . -maxdepth 1 -iname "icon.png" -o -iname "icon.jpg" -o -iname "icon.jpeg" | head -n 1)
          if [ -z "$SOURCE_ICON" ]; then
            echo "ğŸ›‘ é”™è¯¯ï¼šæ²¡æ‰¾åˆ° icon.pngï¼"
            exit 1
          fi
          echo "âœ… é”å®šæºå›¾æ ‡: $SOURCE_ICON"
          echo "SOURCE_ICON_PATH=$SOURCE_ICON" >> $GITHUB_ENV

      - name: Build Xcode Project
        run: |
          PROJECT_FILE=$(find . -maxdepth 2 -name "*.xcodeproj" | head -n 1)
          PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
          SCHEME_NAME="$PROJECT_NAME"
          RANDOM_ID="com.fangyikai.app.$(date +%s)"
          
          xcodebuild clean -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME_NAME" -configuration Release
          
          xcodebuild build \
            -project "$PROJECT_NAME.xcodeproj" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -derivedDataPath build \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="$RANDOM_ID"

      - name: ğŸ’‰ Inject HD Icons (Force Sharpness)
        run: |
          RAW_APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          mkdir Payload
          cp -R "$RAW_APP_PATH" Payload/FangYiKai.app

          TARGET_DIR="Payload/FangYiKai.app"
          SRC="${{ env.SOURCE_ICON_PATH }}"
          
          echo "ğŸ’ æ­£åœ¨æ‰§è¡Œé«˜æ¸…å›¾æ ‡æ¤å…¥..."
          
          # ã€Kingfall æ ¸å¿ƒé€»è¾‘ã€‘
          # ä¸å†ç¼©å°å›¾ç‰‡ï¼Œè€Œæ˜¯å°†æ‰€æœ‰æ–‡ä»¶éƒ½è®¾ä¸ºé«˜æ¸…å°ºå¯¸ (è‡³å°‘ 180pxï¼Œæ¨è 1024px)
          # è¿™æ · iOS ä¼šè‡ªåŠ¨æ‰§è¡Œé«˜è´¨é‡çš„ Downsamplingï¼Œä¿è¯å›¾æ ‡é”åˆ©ã€‚
          
          # è·å–æºå›¾ç‰‡çš„å®½åº¦ï¼Œå¦‚æœå°äº 180ï¼Œå°±åˆ«æŠ˜è…¾äº†ï¼Œç›´æ¥å¤åˆ¶ï¼›å¦‚æœå¾ˆå¤§ï¼Œå°±ä¿æŒåŸæ ·
          # è¿™é‡Œä¸ºäº†ç¨³å¦¥ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰å›¾æ ‡éƒ½é‡å†™ä¸ºæºå›¾ç‰‡çš„å†…å®¹
          
          # 1. åŸºç¡€ AppIcon ç³»åˆ— (Info.plist æŒ‡å‘è¿™ä¸ª)
          cp "$SRC" "$TARGET_DIR/AppIcon.png"
          cp "$SRC" "$TARGET_DIR/AppIcon@2x.png"
          cp "$SRC" "$TARGET_DIR/AppIcon@3x.png"
          
          # 2. è¦†ç›–å¸¸è§çš„å°ºå¯¸å‘½å (é˜²æ­¢ iOS æŠ½é£å»æŠ“æ—§åå­—)
          # å…¨éƒ¨ç”¨åŸå›¾è¦†ç›–ï¼
          cp "$SRC" "$TARGET_DIR/AppIcon-60@2x.png"
          cp "$SRC" "$TARGET_DIR/AppIcon-60@3x.png"
          cp "$SRC" "$TARGET_DIR/AppIcon-76@2x.png"
          cp "$SRC" "$TARGET_DIR/AppIcon-83.5@2x.png"
          cp "$SRC" "$TARGET_DIR/Icon.png"
          cp "$SRC" "$TARGET_DIR/Icon@2x.png"
          cp "$SRC" "$TARGET_DIR/Icon@3x.png"

          # 3. éªŒè¯
          echo "ğŸ“Š æ¤å…¥æ–‡ä»¶åˆ—è¡¨ (æ–‡ä»¶å¤§å°åº”è¯¥æ¯”è¾ƒå¤§):"
          ls -lh "$TARGET_DIR" | grep "png"

          # 4. æ‰“åŒ…
          zip -ry "FangYiKai_HD.ipa" Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: FangYiKai_HD_IPA
          path: ./*.ipa
