name: Custom App Build (V5 Fix)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Auto-Process & Safe Build
        run: |
          # --- 1. æ™ºèƒ½æŸ¥æ‰¾é¡¹ç›® ---
          PROJECT_FILE=$(find . -maxdepth 2 -name "*.xcodeproj" | head -n 1)
          PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
          SCHEME_NAME="$PROJECT_NAME"

          # --- 2. å›¾æ ‡è‡ªåŠ¨åŒ–æ›¿æ¢ ---
          ICON_SET_PATH=$(find . -type d -name "AppIcon.appiconset" | head -n 1)
          SOURCE_ICON="icon.png"

          if [ -f "$SOURCE_ICON" ] && [ -n "$ICON_SET_PATH" ]; then
            echo "âš¡ï¸ å¤„ç†å›¾æ ‡ä¸­..."
            find "$ICON_SET_PATH" -name "*.png" | while read TARGET_IMG; do
              WIDTH=$(sips -g pixelWidth "$TARGET_IMG" | awk '/pixelWidth:/{print $2}')
              sips -Z $WIDTH "$SOURCE_ICON" --out "$TARGET_IMG" > /dev/null
            done
          fi

          # --- 3. ç”Ÿæˆéšæœº Bundle ID ---
          RANDOM_ID="com.fangyikai.app.$(date +%s)"
          echo "âœ… ç”Ÿæˆå”¯ä¸€ ID: $RANDOM_ID"

          # --- 4. æ¸…ç†ä¸æ„å»º ---
          xcodebuild clean -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME_NAME" -configuration Release

          xcodebuild build \
            -project "$PROJECT_NAME.xcodeproj" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -derivedDataPath build \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            PRODUCT_BUNDLE_IDENTIFIER="$RANDOM_ID"

          # --- 5. å®‰å…¨æ‰“åŒ… (å…³é”®ä¿®å¤æ­¥éª¤) ---
          mkdir Payload
          # æ‰¾åˆ°ç¼–è¯‘å¥½çš„ .app æ–‡ä»¶
          RAW_APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          
          if [ -z "$RAW_APP_PATH" ]; then
            echo "âŒ æ„å»ºå¤±è´¥"
            exit 1
          fi

          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…: $RAW_APP_PATH"
          
          # ã€Kingfall æ ¸å¿ƒä¿®å¤ã€‘ï¼š
          # ä¸ç®¡åŸæ¥çš„åå­—æ˜¯ä¸­æ–‡è¿˜æ˜¯ä¹±ç ï¼Œæˆ‘ä»¬å¤åˆ¶çš„æ—¶å€™ä¿æŒåŸåï¼Œ
          # ä½†å› ä¸ºæˆ‘ä»¬ä¿®æ”¹äº† Info.plist çš„ CFBundleName ä¸ºè‹±æ–‡ï¼Œ
          # æ‰€ä»¥è¿™é‡Œçš„ RAW_APP_PATH åº”è¯¥æ˜¯è‹±æ–‡åï¼ˆå¦‚ FangYiKai.appï¼‰ã€‚
          # å¦‚æœè¿™é‡Œå¸¦æœ‰ä¸­æ–‡ï¼ŒSideStore å¿…æŒ‚ã€‚
          
          cp -R "$RAW_APP_PATH" Payload/
          
          # ä½¿ç”¨ -y å‚æ•°ä¿ç•™ç¬¦å·é“¾æ¥ï¼Œé˜²æ­¢ç»“æ„æŸå
          zip -ry "FangYiKai_App.ipa" Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: FangYiKai_Final_IPA
          path: ./*.ipa
